#Include "TextLib" as TextLib
#Include "MathLib" as MathLib

#Include "Libs/BigBang1112/Settings.Script.txt" as Settings
#Include "Libs/BigBang1112/Manialink.Script.txt" as Manialink
#Include "Libs/BigBang1112/Layers.Script.txt" as Layers
#Include "Libs/BigBang1112/Task.Script.txt" as Task

#Include "Libs/Challenge/ModifierBase.Script.txt" as ModifierBase
#Include "Libs/Challenge/Vehicle.Script.txt" as Vehicle

#Struct SGhostInfo {
	Text Nickname;
	Integer Time;
	Integer[] Checkpoints;
	Text File;
	Boolean IsMedal;
	Boolean IsAuthorMedal;
	Boolean IsGoldMedal;
	Boolean IsSilverMedal;
	Boolean IsBronzeMedal;
	Text Vehicle;
}

#Const C_Manialink "Media/Manialinks/Base/Ingame/Menu"
#Const C_Manialink_OpenMenu "Media/Manialinks/Base/Ingame/OpenMenu"

Void Init() {
	Layers::Create("Menu", Manialink::FromFile(C_Manialink, True, ["Audio", "SlideText", "Navigation"], Settings::Get().Theme));
}

Void Start() {
	Layers::Show("Menu", True);
	Layers::SendEvent("Menu", "Navigation", "True");

	declare metadata ModifierBase::SChMap OriginalMap for Map;
	Layers::SendEvent("Menu", "MapName", OriginalMap.Name);
	Layers::SendEvent("Menu", "Challenge", TextLib::ToUpperCase(TextLib::Replace(Map.MapStyle, "+", " + ")));

	declare metadata Integer[Text] Validations for Map;
	declare Integer[Text] OldValidations for Map;
	OldValidations = Validations;
}

Void CheckMode() {
	declare netread Boolean Server_IsValidationMode for UI;
	
	if(Server_IsValidationMode) {
		Layers::Create("OpenMenu", Manialink::FromFile(C_Manialink_OpenMenu, True, ["Audio"], Settings::Get().Theme));
	}
	else {
		Layers::SetType("Menu", CUILayer::EUILayerType::InGameMenu);
		Layers::SetType("Vehicle", CUILayer::EUILayerType::InGameMenu);
		Layers::SendEvent("Menu", "Open");
	}
}

SGhostInfo[] SortGhosts(SGhostInfo[] _Ghosts) {
	declare SGhostInfo[] Final;
	declare Integer[] Sort;
	foreach(Ghost,_Ghosts) {
		if(Ghost.Time == -1)
			Final.add(Ghost);
		else
			Sort.add(Ghost.Time);
	}
	Sort = Sort.sort();
	for(I,0,Sort.count-1) {
		foreach(Ghost,_Ghosts) {
			if(Ghost.Time == Sort[Sort.count-1-I]) Final.addfirst(Ghost);
		}
	}
	return Final;
}

Void UpdateMedals() {
	declare netread Vehicle::SVehicle[] Server_Vehicles for UI;
	declare netread Integer Server_CurrentVehicle for UI;
	declare VehicleName = Server_Vehicles[Server_CurrentVehicle].Name;
	declare metadata Integer[Text] Validations for Map;

	declare SGhostInfo[] LoadedGhosts for Layers::Page("Menu");

	for(I,0,LoadedGhosts.count-1)
	for(J,0,LoadedGhosts.count-1) {
		if(LoadedGhosts.existskey(J) && LoadedGhosts[J].IsMedal) {
			declare Removed = LoadedGhosts.removekey(J);
			continue;
		}
	}

	if(Validations.existskey(VehicleName)) {
		declare SGhostInfo Ghost;
		Ghost.Nickname = LocalUser.Name;
		Ghost.Time = Validations[VehicleName];
		Ghost.IsMedal = True;
		Ghost.IsAuthorMedal = True;
		Ghost.Vehicle = VehicleName;
		LoadedGhosts.add(Ghost);

		Ghost.Time = MathLib::NearestInteger(Validations[VehicleName]*1.1);
		Ghost.IsAuthorMedal = False;
		Ghost.IsGoldMedal = True;
		LoadedGhosts.add(Ghost);

		Ghost.Time = MathLib::NearestInteger(Validations[VehicleName]*1.2);
		Ghost.IsGoldMedal = False;
		Ghost.IsSilverMedal = True;
		LoadedGhosts.add(Ghost);

		Ghost.Time = MathLib::NearestInteger(Validations[VehicleName]*1.5);
		Ghost.IsSilverMedal = False;
		Ghost.IsBronzeMedal = True;
		LoadedGhosts.add(Ghost);
	}

	LoadedGhosts = SortGhosts(LoadedGhosts);
	Layers::SendEvent("Menu", "UpdateLoadedGhosts");
}

Boolean ValidationChanged() {
	declare metadata Integer[Text] Validations for Map;
	declare Integer[Text] OldValidations for Map;

	if(Validations.count != OldValidations.count) {
		OldValidations = Validations;
		return True;
	}
	else {
		for(I,0,Validations.count-1) {
			foreach(Car => Validation,Validations)
			if(Validation != OldValidations[Car]) {
				OldValidations = Validations;
				return True;
			}
		}
	}

	return False;
}

Void Event(CManiaAppEvent _Event) {
	declare Text[] Exchange for This;

	switch(_Event.Type) {
		case CManiaAppPlaygroundEvent::EType::LayerCustomEvent: {
			switch(_Event.CustomEventLayer) {
				case Layers::Get("Menu"): {
					switch(_Event.CustomEventType) {
						case "Open": {
							declare netread Boolean Server_IsValidationMode for UI;
							declare netread Boolean Server_EndRace for UI;
							declare netread Boolean Server_Outro for UI;

							if(!Server_EndRace && !Server_Outro) {
								Exchange.add("HideIngame");
								if(Server_IsValidationMode)
									Layers::Hide("OpenMenu");
								Layers::Hide("Flash");

								Layers::SendEvent("Menu", "Navigation", "True");
							}

							declare Integer CurrentSection for Layers::Page("Menu");
							if(CurrentSection == 0)
								Task::Async_DataFileMgr("LOCAL_GHOSTS", DataFileMgr.Replay_GetGameList("", True));

							UpdateMedals();
						}
						case "Close": {
							declare netread Boolean Server_IsValidationMode for UI;
							declare netread Boolean Server_EndRace for UI;
							declare netread Boolean Server_Outro for UI;

							if(!Server_EndRace && !Server_Outro) {
								Exchange.add("ShowIngame");
								if(Server_IsValidationMode)
									Layers::Show("OpenMenu", True);
								Layers::Show("Flash", True);
							}
						}
						case "Exit": {
							declare Boolean Close for This;
							Close = True;
						}
						case "FetchRecords": {
							declare Zone = _Event.CustomEventData[0];
							log(Zone);
							declare SGhostInfo[] LoadedGhosts for Layers::Page("Menu");
							LoadedGhosts.clear();
							Layers::SendEvent("Menu", "UpdateLoadedGhosts");
						}
						case "FetchLocalGhosts": {
							Task::Async_DataFileMgr("LOCAL_GHOSTS", DataFileMgr.Replay_GetGameList("", True));
						}
						case "UpdateMedals": {
							UpdateMedals();
						}
					}
				}
				case Layers::Get("OpenMenu"): {
					switch(_Event.CustomEventType) {
						case "Menu": {
							SendCustomEvent("Menu", []);

							Layers::Show("Menu", True);
							Layers::Show("Vehicle", True);

							Exchange.add("HideIngame");

							Layers::Hide("OpenMenu");

							Layers::Hide("Flash");
						}
					}
				}
			}
		}
	}
}

declare CTaskResult_GhostList[] LoadedGhosts_Task;
declare Text[Ident] LoadedGhosts_Task_Files;

Void Async() {
	if(Task::IsCompleted("LOCAL_GHOSTS")) {
		if(Task::IsSuccessful("LOCAL_GHOSTS")) {
			declare ReplayList = (Task::Get("LOCAL_GHOSTS") as CTaskResult_ReplayList);

			declare SGhostInfo[] LoadedGhosts for Layers::Page("Menu");

			foreach(Replay, ReplayList.ReplayInfos) {
				if(Map.MapInfo.MapUid != "" && Replay.MapUid == Map.MapInfo.MapUid) {
					declare Continue = False;
					foreach(Ghost, LoadedGhosts)
						if(Replay.FileName == Ghost.File) Continue = True;
					if(Continue) continue;

					declare Task = DataFileMgr.Replay_Load(Replay.FileName);
					LoadedGhosts_Task_Files[Task.Id] = Replay.FileName;
					LoadedGhosts_Task.add(Task);
				}
			}

			Task::Destroy_DataFileMgr("LOCAL_GHOSTS");
		}
	}

	declare SGhostInfo[] LoadedGhosts for Layers::Page("Menu");
	for(I, 0, LoadedGhosts_Task.count-1) {
		if(LoadedGhosts_Task.existskey(I)) {
			declare GhostTask = LoadedGhosts_Task[I];
			if(!GhostTask.IsProcessing) {
				if(GhostTask.HasSucceeded && GhostTask.Ghosts.count > 0) {
					declare Ghost = GhostTask.Ghosts[0];
					declare SGhostInfo Info;
					Info.Nickname = Ghost.Nickname;
					Info.Time = Ghost.Result.Time;
					Info.File = LoadedGhosts_Task_Files[GhostTask.Id];
					foreach(Checkpoint, Ghost.Result.Checkpoints)
						Info.Checkpoints.add(Checkpoint);
					LoadedGhosts.add(Info);

					LoadedGhosts = SortGhosts(LoadedGhosts);

					Layers::SendEvent("Menu", "UpdateLoadedGhosts");
				}
				else if(GhostTask.HasFailed) {

				}

				declare Removed = LoadedGhosts_Task.removekey(I);
				declare Removed2 = LoadedGhosts_Task_Files.removekey(GhostTask.Id);

				DataFileMgr.TaskResult_Release(GhostTask.Id);
			}
		}
	}

	if(ValidationChanged()) {
		UpdateMedals();
	}
}