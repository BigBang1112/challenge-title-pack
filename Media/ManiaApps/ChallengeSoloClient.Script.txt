#RequireContext CManiaAppPlayground

#Include "TextLib" as TextLib

#Include "Libs/BigBang1112/Layers.Script.txt" as Layers
#Include "Libs/BigBang1112/Manialink.Script.txt" as Manialink
#Include "Libs/BigBang1112/Settings.Script.txt" as Settings
#Include "Libs/BigBang1112/Http.Script.txt" as Http
#Include "Libs/BigBang1112/Random.Script.txt" as Random
#Include "Libs/BigBang1112/Map.Script.txt" as Map

#Include "Libs/Challenge/Backend.Script.txt" as Backend
#Include "Libs/Challenge/ModifierBase.Script.txt" as ModifierBase

#Struct SPlaysession {
	Text Login;
	Text Token;
	Text MapUid;
	Text Car;
	Text Secret;
	Text Action;
	Text TitleId;
}

#Struct SAuthToken {
	Text Value; // Token value
	Integer Length;
	Boolean Successful; // If token was received successfully
	Boolean Verified; // If token was verified as valid
	Integer Time; // How long the request took
	Integer EndTime; // When request was finished
	Integer Expires;
	Text Response; // Short informational response
}

ClientUI.OverlayHideCheckPointList = True;
ClientUI.OverlayHideSpeedAndDist = True;
ClientUI.OverlayHidePersonnalBestAndRank = True;
ClientUI.OverlayHideChrono = True;
ClientUI.OverlayHidePosition = True;

Layers::Create("Ingame", Manialink::FromFile("Media/Manialinks/SoloIngame", True, ["TextAnimation"], Settings::Get().Theme), True);

declare SAuthToken INGAME_TOKEN for LocalUser;

declare SPlaysession Playsession;
Playsession.Login = LocalUser.Login;
Playsession.Token = INGAME_TOKEN.Value;
Playsession.MapUid = Map.MapInfo.MapUid;
Playsession.Car = "StadiumCar";
Playsession.Secret = Random::String(32);
Playsession.Action = "Playing";
Playsession.TitleId = LoadedTitle.TitleId;

log(INGAME_TOKEN.Value);

declare Req = Http::SyncPOST("""{{{Backend::GetHost()}}}/ingame/playsession""", Playsession.tojson(), "Content-Type: application/json\nContent-Length: "^TextLib::Length(Playsession.tojson()));
log(Req.Result);
Http.Destroy(Req);

declare metadata ModifierBase::SChMap OriginalMap for Map;
Map.MapName = OriginalMap.Name ^ "$z (" ^ OriginalMap.CollectionName ^ ", " ^ TextLib::Replace(Map.MapStyle, "+", " ") ^ ", StadiumCar)";

//sleep(3000);
//log(Http::SyncGET("""{{{Backend::GetHost()}}}/ingame/playsession?login={{{Playsession.Login}}}&token={{{Playsession.Token}}}&mapuid={{{Playsession.MapUid}}}&car=StadiumCar&secret={{{Playsession.Secret}}}&action=succmydic""").Result);

while(True) {
	yield;
}